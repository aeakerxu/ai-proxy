<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>æˆ‘çš„ AI èŠå¤© - api.awaker.top</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f7f7f8; --card:#fff; --border:#eaeaea; --text:#111; --muted:#888; --primary:#111; }
    *{box-sizing:border-box}
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial; margin:0; color:var(--text); background:var(--bg);}
    .app { display:flex; min-height:100vh; }

    .sidebar { width:260px; border-right:1px solid var(--border); background:#fafafa; padding:12px; display:flex; flex-direction:column; gap:8px; }
    .sidebar h2{font-size:14px;margin:8px 4px;color:#444}
    .chat-item{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer; display:flex; align-items:center; justify-content:space-between; gap:8px}
    .chat-item.active{border-color:#000}
    .chat-title{flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .chat-actions{display:flex; gap:6px}
    .icon-btn{border:1px solid var(--border); background:#fff; border-radius:8px; padding:4px 6px; cursor:pointer}
    .icon-btn:hover{background:#f2f2f2}

    .btn { padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer }
    .btn.primary { background:var(--primary); color:#fff; border-color:var(--primary) }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .row { display:flex; gap:8px }
    .muted { color:var(--muted); font-size:12px; }

    .main { flex:1; display:flex; flex-direction:column; min-width:0; }
    .topbar { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border); background:#fff; position:sticky; top:0; z-index:5}
    .topbar .left, .topbar .right { display:flex; gap:8px; align-items:center }
    select, input[type="password"] { padding:8px 10px; border-radius:10px; border:1px solid var(--border) }

    .wrap { max-width:900px; margin:0 auto; padding:12px; width:100% }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; display:flex; flex-direction:column; height: calc(100vh - 140px); }

    .chat-box { flex:1; overflow-y:auto; padding:16px; }
    .msg { margin:10px 0; line-height:1.7; position:relative; }
    .msg .bubble { display:inline-block; padding:10px 12px; border-radius:12px; white-space:pre-wrap; max-width:100%; }
    .msg.user { text-align:right; }
    .msg.user .bubble { background:#e6f0ff; }
    .msg.bot .bubble { background:#f1f1f1; }
    .copy-btn{ position:absolute; right:0; top:-6px; font-size:12px; color:#666; cursor:pointer; padding:2px 6px; border-radius:6px; border:1px solid var(--border); background:#fff; }
    .copy-btn:hover{background:#f2f2f2}

    .composer { display:flex; gap:8px; padding:12px; border-top:1px solid var(--border) }
    textarea { flex:1; resize:vertical; min-height:68px; padding:10px; border-radius:10px; border:1px solid var(--border); font-size:16px; }
    .send-btn { min-width:110px }

    @media (max-width: 900px){
      .sidebar{ display:none; }
      .card{ height: calc(100vh - 120px); }
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- å·¦ä¾§ï¼šèŠå¤©åˆ—è¡¨ -->
    <aside class="sidebar">
      <div class="row">
        <button class="btn primary" id="newChatBtn">æ–°å»ºèŠå¤©</button>
        <button class="btn" id="exportBtn">å¯¼å‡ºå¯¹è¯</button>
      </div>
      <div class="row">
        <button class="btn" id="logoutBtn">é€€å‡ºç™»å½•</button>
        <button class="btn" id="settingsBtn">è®¾ç½®</button>
      </div>
      <h2>ä½ çš„èŠå¤©</h2>
      <div id="chatList"></div>
    </aside>

    <!-- å³ä¾§ï¼šä¸»ç•Œé¢ -->
    <main class="main">
      <div class="topbar">
        <div class="left">
          <strong>api.awaker.top</strong>
          <span class="muted">OpenAI å…¼å®¹ / é€šä¹‰ Â· çœŸæµå¼</span>
          <label class="muted">æ¨¡å‹</label>
          <select id="modelSel">
            <option value="qwen-plus">qwen-plus</option>
            <option value="qwen-max">qwen-max</option>
          </select>
        </div>
        <div class="right">
          <input id="token" type="password" placeholder="è®¿é—®å¯†ç ï¼ˆæ­¤çª—å£æœ‰æ•ˆï¼‰" />
          <button class="btn" id="saveToken">ä¿å­˜å¯†ç </button>
        </div>
      </div>

      <div class="wrap">
        <div class="card">
          <div id="chat" class="chat-box"></div>
          <div class="composer">
            <textarea id="input" placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼ŒShift+Enteræ¢è¡Œï¼ŒEnterå‘é€"></textarea>
            <button class="btn primary send-btn" id="send">å‘é€</button>
          </div>
        </div>
        <div class="muted" style="margin-top:8px">
          å½“å‰ä¸ºé€šä¹‰ OpenAI å…¼å®¹æ¥å£ + SSE çœŸæµå¼è¾“å‡ºã€‚
        </div>
      </div>
    </main>
  </div>

  <script>
    // === DOM ===
    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const tokenEl = document.getElementById('token');
    const saveTokenBtn = document.getElementById('saveToken');
    const modelSel = document.getElementById('modelSel');
    const chatListEl = document.getElementById('chatList');
    const newChatBtn = document.getElementById('newChatBtn');
    const exportBtn = document.getElementById('exportBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const settingsBtn = document.getElementById('settingsBtn');

    // === å­˜å‚¨é”® ===
    const LS_CHATS = 'AIOPS_CHATS';
    const LS_MODEL = 'AIOPS_MODEL';
    const SS_TOKEN = 'CHAT_ACCESS_TOKEN';

    // === æ•°æ® ===
    const systemMsg = { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„ä¸­æ–‡åŠ©æ‰‹ã€‚" };
    let chats = loadChats();
    let currentId = chats[0]?.id || null;

    function uuid() { return 'c'+Math.random().toString(36).slice(2)+Date.now().toString(36); }

    function loadChats() {
      try {
        const raw = localStorage.getItem(LS_CHATS);
        return raw ? JSON.parse(raw) : [ { id: uuid(), title: "æ–°çš„èŠå¤©", messages: [systemMsg], created: Date.now() } ];
      } catch (e) {
        console.error("parse chats failed", e);
        return [ { id: uuid(), title: "æ–°çš„èŠå¤©", messages: [systemMsg], created: Date.now() } ];
      }
    }

    function getCurrent() { return chats.find(c => c.id === currentId); }

    function persist() {
      localStorage.setItem(LS_CHATS, JSON.stringify(chats));
      localStorage.setItem(LS_MODEL, modelSel.value);
    }

    function renderList() {
      chatListEl.innerHTML = '';
      chats.forEach(c => {
        const item = document.createElement('div');
        item.className = 'chat-item' + (c.id===currentId ? ' active':'');
        const title = document.createElement('div');
        title.className = 'chat-title';
        title.textContent = c.title || 'æœªå‘½åå¯¹è¯';
        title.ondblclick = () => {
          const val = prompt('ä¿®æ”¹æ ‡é¢˜ï¼š', c.title || '');
          if (val !== null) { c.title = val.trim() || c.title; persist(); renderList(); }
        };
        const actions = document.createElement('div');
        actions.className = 'chat-actions';
        const del = document.createElement('button');
        del.className = 'icon-btn';
        del.title = 'åˆ é™¤';
        del.textContent = 'ğŸ—‘';
        del.onclick = (e) => {
          e.stopPropagation();
          if (confirm('ç¡®å®šåˆ é™¤è¯¥å¯¹è¯ï¼Ÿ')) {
            chats = chats.filter(x => x.id !== c.id);
            if (currentId === c.id) currentId = chats[0]?.id || null;
            persist(); renderList(); renderChat();
          }
        };
        actions.appendChild(del);

        item.onclick = () => { currentId = c.id; renderList(); renderChat(); };
        item.appendChild(title);
        item.appendChild(actions);
        chatListEl.appendChild(item);
      });
      if (!chats.length) {
        const d = document.createElement('div');
        d.className='muted';
        d.textContent='æš‚æ— èŠå¤©ï¼Œç‚¹â€œæ–°å»ºèŠå¤©â€å¼€å§‹';
        chatListEl.appendChild(d);
      }
    }

    function renderChat() {
      chatEl.innerHTML = '';
      const c = getCurrent();
      if (!c) return;
      c.messages.filter(m => m.role !== "system").forEach(m => addMsg(m.role, m.content));
    }

    function addMsg(role, text) {
      const div = document.createElement('div');
      div.className = 'msg ' + (role === 'user' ? 'user' : 'bot');

      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = text;
      div.appendChild(b);

      if (role !== 'user') {
        const copy = document.createElement('button');
        copy.className = 'copy-btn';
        copy.textContent = 'å¤åˆ¶';
        copy.onclick = () => {
          const liveText = b.textContent || '';
          navigator.clipboard.writeText(liveText).then(()=>{
            copy.textContent='å·²å¤åˆ¶';
            setTimeout(()=>copy.textContent='å¤åˆ¶',1200);
          });
        };
        div.appendChild(copy);
      }

      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
      return b;
    }

    // åˆå§‹å›å¡«
    tokenEl.value = sessionStorage.getItem(SS_TOKEN) || '';
    modelSel.value = localStorage.getItem(LS_MODEL) || 'qwen-plus';
    renderList(); if (currentId) renderChat();

    // äº‹ä»¶ç»‘å®š
    newChatBtn.onclick = () => {
      const id = uuid();
      chats.unshift({ id, title:"æ–°çš„èŠå¤©", messages:[systemMsg], created:Date.now() });
      currentId = id; persist(); renderList(); renderChat();
    };

    exportBtn.onclick = () => {
      const c = getCurrent(); if (!c) return;
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(c,null,2));
      const a = document.createElement('a');
      a.href = dataStr; a.download = (c.title || 'chat') + '.json'; a.click();
    };

    logoutBtn.onclick = () => {
      sessionStorage.removeItem(SS_TOKEN);
      tokenEl.value = '';
      alert('å·²æ¸…é™¤å½“å‰çª—å£çš„è®¿é—®å¯†ç ');
    };

    settingsBtn.onclick = () => alert('è®¾ç½®å ä½ï¼šåç»­å¯æ·»åŠ ä¸»é¢˜ / å¿«æ·é”® / æ¸©åº¦ç­‰å‚æ•°');

    saveTokenBtn.onclick = () => {
      const v = tokenEl.value.trim();
      if (!v) return alert('è¯·è¾“å…¥è®¿é—®å¯†ç ');
      sessionStorage.setItem(SS_TOKEN, v);
      alert('å·²ä¿å­˜ï¼ˆä»…å½“å‰çª—å£æœ‰æ•ˆï¼‰');
    };

    modelSel.onchange = () => persist();

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });
    sendBtn.onclick = () => send();

    async function send() {
      const text = inputEl.value.trim();
      if (!text) return;

      const token = (tokenEl.value || sessionStorage.getItem(SS_TOKEN) || '').trim();
      if (!token) return alert('è¯·å…ˆå¡«å†™å¹¶ä¿å­˜è®¿é—®å¯†ç ');

      const chat = getCurrent(); if (!chat) return;

      inputEl.value = '';
      addMsg('user', text);

      if (!chat.title || chat.title === 'æ–°çš„èŠå¤©') {
        chat.title = text.slice(0, 20);
      }

      const model = modelSel.value || 'qwen-plus';

      const baseBody = {
        model,
        messages: [...chat.messages, { role:"user", content:text }],
        temperature: 0.7,
        stream: true   // æ°¸è¿œæµå¼
      };

      // Loading
      sendBtn.disabled = true;
      const oldSendText = sendBtn.textContent;
      sendBtn.textContent = 'æµå¼ç”Ÿæˆä¸­â€¦';

      try {
        const resp = await fetch('/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Access-Token': token
          },
          body: JSON.stringify(baseBody)
        });

        if (!resp.ok || !resp.body) {
          const msg = resp.status === 401 ? 'è®¿é—®å¯†ç é”™è¯¯'
                    : resp.status === 429 ? 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•'
                    : `æœåŠ¡å™¨é”™è¯¯ ${resp.status}`;
          addMsg('assistant', 'âŒ ' + msg);
          console.error('HTTP', resp.status, await resp.text().catch(()=>'')); 
          return;
        }

        const reader = resp.body.getReader();
        const decoder = new TextDecoder('utf-8');

        let buffer = '';
        let finalText = '';

        // å…ˆç”»ä¸€ä¸ªæ°”æ³¡ï¼Œè¾¹æ”¶è¾¹åŠ å­—
        const botBubble = addMsg('assistant', '');

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });

          buffer = buffer.replace(/\r\n/g, '\n');
          const events = buffer.split('\n\n');
          buffer = events.pop() || '';

          for (const evt of events) {
            const lines = evt.split('\n');
            for (const line of lines) {
              const s = line.trim();
              if (!s.startsWith('data:')) continue;
              const data = s.slice(5).trim();
              if (!data) continue;
              if (data === '[DONE]') {
                buffer = '';
                break;
              }
              try {
                const json = JSON.parse(data);
                const choice = json?.choices?.[0];
                const delta = choice?.delta;
                const piece = delta?.content ?? choice?.message?.content ?? '';
                if (piece) {
                  finalText += piece;
                  botBubble.textContent += piece;
                  chatEl.scrollTop = chatEl.scrollHeight;
                }
              } catch (e) {
                // å¿½ç•¥é JSON / åŠæˆª JSON
              }
            }
          }
        }

        chat.messages.push({ role:"user", content:text });
        chat.messages.push({ role:"assistant", content: finalText || '[æ— å†…å®¹]' });
        persist(); renderList();

      } catch (e) {
        addMsg('assistant', 'âŒ ç½‘ç»œå¼‚å¸¸æˆ–è·¨åŸŸå¤±è´¥ï¼š' + (e.message || e));
        console.error(e);
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = oldSendText;
      }
    }
  </script>
</body>
</html>
